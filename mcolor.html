<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="jquery.min.js"></script>
    <style>
        .block
        {
            width: 32px;
            height: 32px;
            display: block;
            float: left;
            margin: 1px;
        }
        .subBlock
        {
            width: 16px;
            height: 16px;
            position: relative;
            right: 0px;
        }
        .right
        {
            top: 16px;
            left: 16px;
        }
        .left
        {
            float: left;
            top: 16px;
        }
        .lastCol
        {
            clear: left;
        }
        body
        {
            background-color: #333333;
        }
        #gameArea
        {
            float: left;
        }
        #ctrlZ
        {
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id="gameArea">
    <!---->
</div>
<p id="score" style="color: white">score: 0</p>

<span id="ctrlZ">CTRL+Z</span>

</body>
<script type="text/javascript">
    var blocksArray = [];
    var size = 16;
    var colors = ['#FFCC00', '#FF3300', '#FF9900'];//, '#0011FF', '#37FF00', '#FFFFFF', '#FFC2E0', '#E8EBFF'];
    var selectedBlock = {row:-1, col:-1};
    var hoveredBlock = {row:-1, col:-1};
    var score = 0;
    var historyArray = [];//{blocksArray: [], hoveredBlock: {}, selectedBlock: {}, score: 0}

    /*
    * undoCommand types:
     * 1 -- changed color in multicolor cell
     * 2 -- remove cells block
    * */

    function addSnapshotBeforeChangeColorInMulticolorCell(cellRow, cellCol)
    {
        var undoCommand = {commandType: 1, row: cellRow, col: cellCol, cellColor: blocksArray[cellRow][cellCol]};
        historyArray.push(undoCommand);
    }

    function addSnapshotBeforeCellsBlockRemove(color, cells)
    {
        var undoCommand = {commandType: 2, color: color, cells: cells, score: score};
        historyArray.push(undoCommand);
    }

    $("#ctrlZ").click(function(){
        if(historyArray != undefined && historyArray.length > 0)
        {
            ctrlZ();
        }
    });

    function ctrlZ()
    {
        var historyItem = historyArray[historyArray.length-1];

        historyArray.pop();

        switch(historyItem.commandType)
        {
            case 1:
                //cancel select color in multicolor cell
                initBlock(historyItem.row, historyItem.col, historyItem.cellColor);
                break;

            case 2:
                selectedBlock = {row: -1, col: -1};

                var prevScore = historyItem.score;
                var cells = historyItem.cells;
                var color = historyItem.color;

                for(var i = 0; i < cells.length; i++)
                {
                    var cell = cells[i];
                    initBlock(cell.row, cell.col, color);
                }

                score = prevScore;
                $('#score').text("score: " + score);
                break;
        }
    }

    function addSubBlock(block, color1, color2)
    {
        var l = $('<div/>')
                .addClass('subBlock left')
                .css({
                    "background-color": colors[color1],
                    "display" : "none"
                });

        var r = $('<div/>')
                .addClass('subBlock right')
                .css({
                    "background-color": colors[color2],
                    "display" : "none"
                });

        $(l).click(function(){
            var row = $(block).attr('data-row');
            var col = $(block).attr('data-col');

            addSnapshotBeforeChangeColorInMulticolorCell(row, col);

            initBlock(row, col, color1);
        });

        $(r).click(function(){
            var row = $(block).attr('data-row');
            var col = $(block).attr('data-col');

            addSnapshotBeforeChangeColorInMulticolorCell(row, col);

            initBlock(row, col, color2);
        });

        $(block).append(l).append(r);
    }

    function initBlock(row, col, color)
    {
        blocksArray[row][col] = color;

        var block =
                $('<div></div>')
                        .addClass('block').addClass(col == 0 ? "lastCol" : "")
                        .attr("data-row", row)
                        .attr("data-col", col)
                        .attr("id", row+"_"+col)
                        .css("background-color", color != -1 ? colors[color] : "#333333");

        switch(color)
        {
            case 2:
                addSubBlock(block, 0, 1);
                break;
            case 4:
                addSubBlock(block, 1, 3);
                break;
            case 6:
                addSubBlock(block, 5, 0);
                break;
            case 7:
                addSubBlock(block, 5, 3);
                break;
        }

        block.hover(function()
        {
            var row = $(this).attr('data-row');
            var col = $(this).attr('data-col');
            var hoveredDiv = $('#'+hoveredBlock.row+"_"+hoveredBlock.col);

            if(selectedBlock.row == row && selectedBlock.col == col)
            {
                hoveredDiv.find("div.subBlock").css('display', 'none');
                return;
            }

            if(hoveredBlock.row != -1 && hoveredBlock.col != -1)
            {
                hoveredDiv.find("div.subBlock").css('display', 'none');
            }

            hoveredBlock = {row: row, col: col};
            $(this).find("div.subBlock").css('display', 'block');
        });

        block.click(function()
        {
            $(this).find("div.subBlock").css('display', 'none');

            var row = $(this).attr('data-row');
            var col = $(this).attr('data-col');

            cellClick(row, col);
        });

        $('#gameArea #'+row+'_'+col).replaceWith(block);
    }

    function deselectCell(row, col)
    {
        $('#gameArea #'+row+"_"+col).text("");
        initBlock(row, col, blocksArray[row][col]);
    }

    function cellClick(row, col)
    {
        //if selected cell is empty yet
        if(blocksArray[row][col] == -1) //colorNum is -1 -- empty cell
        {
            return;
        }

        //if click by already selected cell
        if(selectedBlock.row == row && selectedBlock.col == col)
        {
            selectedBlock = {row: -1, col: -1};
            deselectCell(row, col);
            return;
        }

        //if its first selection
        if(selectedBlock.row == -1 && selectedBlock.col == -1)
        {
            selectedBlock = {row: row, col: col};
            $('#gameArea #'+row+"_"+col).prepend("*");
            return;
        }

        if(row == selectedBlock.row || col == selectedBlock.col)
        {
            deselectCell(selectedBlock.row, selectedBlock.col);
            selectedBlock = {row: row, col: col};
            $('#gameArea #'+row+"_"+col).prepend("*");
            return;
        }

        var
                minRow = Math.min(selectedBlock.row, row),
                minCol = Math.min(selectedBlock.col, col),
                maxRow = Math.max(selectedBlock.row, row),
                maxCol = Math.max(selectedBlock.col, col);

        var startCellColor = blocksArray[selectedBlock.row][selectedBlock.col];
        var emptyBlocksCount = 0;
        var allRight = true;
        var cellsForRemove = [];
        for(var r = minRow; r <= maxRow; r++)
        {
            if(!allRight)
                break;

            for(var c = minCol; c <= maxCol; c++)
            {
                if(blocksArray[r][c] != -1 && blocksArray[r][c] != startCellColor)
                {
                    allRight = false;
                    deselectCell(selectedBlock.row, selectedBlock.col);
                    selectedBlock = {row: row, col: col};
                    $('#gameArea #'+row+"_"+col).prepend("*");
                    break;
                }
                else if(blocksArray[r][c] == -1)
                {
                    emptyBlocksCount += 0.5;
                }
                else
                {
                    cellsForRemove.push({row:r, col:c});
                }
            }
        }

        if(allRight)
        {
            addSnapshotBeforeCellsBlockRemove(startCellColor, cellsForRemove);

            for(r = minRow; r <= maxRow; r++)
            {
                for(c = minCol; c <= maxCol; c++)
                {
                    initBlock(r,c,-1);
                }
            }
            selectedBlock = {row: -1, col: -1};

            var currentScore =((1+maxRow-minRow) * (1+maxCol-minCol) - emptyBlocksCount);

            var bonus = 0;
            if(emptyBlocksCount == 0)
            {
                bonus = currentScore / 2;
            }

            score += currentScore + bonus;
            $('#score').text("score: " + score);
        }
    }

    function getRandomColorNum()
    {
        return Math.floor(Math.random()*3);
    }

    function initArea()
    {
        var gameArea = $('#gameArea').css({width: size*34, height: size*34});
        gameArea.empty();

        for(var i = 0; i < size; i++)
        {
            for(var j = 0; j < size; j++)
            {
                gameArea.append($('<div/>').attr('id', i+"_"+j));
                initBlock(i, j, blocksArray[i][j])
            }
        }
    }

    $(document).ready(function(){

        //fill gameArea with random color's cells
        selectedBlock = {row:-1, col:-1};
        hoveredBlock = {row:-1, col:-1};
        blocksArray = [];
        for(var i = 0; i < size; i++)
        {
            blocksArray[i] = [];
            for(var j = 0; j < size; j++)
            {
                blocksArray[i][j] = getRandomColorNum();
            }
        }

        initArea();
    });
</script>
</html>